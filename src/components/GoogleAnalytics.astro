---
// src/components/GoogleAnalytics.astro - ä¿®æ­£ç‰ˆ
const measurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
const isProduction = import.meta.env.PROD;

// pages.devãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã®è¨ˆæ¸¬ã‚’æœ‰åŠ¹åŒ–ï¼ˆç’°å¢ƒæ§‹ç¯‰æ®µéšï¼‰
const site = Astro.site?.toString() || import.meta.env.SITE || '';
const isPagesDevDomain = site.includes('.pages.dev');

// ç¾æ®µéšï¼špages.devã§ã®ã¿è¨ˆæ¸¬ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ç§»è¡Œå¾Œã«æ¡ä»¶å¤‰æ›´ï¼‰
const shouldTrack = isProduction && isPagesDevDomain && measurementId;
// // pages.devã‹ã‚‰æœ¬ç•ªãƒ‰ãƒ¡ã‚¤ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ
// const shouldTrack = isProduction && !isPagesDevDomain && measurementId;

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºæ™‚ã®ã¿è¡¨ç¤ºï¼‰
if (!isProduction) {
  console.log('ğŸ” GA4 Debug Info:');
  console.log('  Measurement ID:', measurementId);
  console.log('  Is Production:', isProduction);
  console.log('  Is Pages.dev:', isPagesDevDomain);
  console.log('  Should Track:', shouldTrack);
}
---

{shouldTrack && (
  <>
    <!-- Google tag (gtag.js) with Partytown -->
    <script
      type="text/partytown"
      src={`https://www.googletagmanager.com/gtag/js?id=${measurementId}`}
    ></script>
    
    <!-- âœ… define:vars ã§å¤‰æ•°ã‚’æ­£ã—ãå±•é–‹ -->
    <script type="text/partytown" define:vars={{ measurementId }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      // âœ… å¤‰æ•°ã¨ã—ã¦æ­£ã—ãæ¸¡ã•ã‚Œã‚‹
      gtag('config', measurementId, {
        send_page_view: true,
        anonymize_ip: true,
        debug_mode: false
      });
    </script>
  </>
)}
