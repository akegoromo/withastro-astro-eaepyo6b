name: microCMS to Astro Deployment

on:
  repository_dispatch:
    types: [microcms-webhook]
  schedule:
    - cron: "0 15 * * *"
  workflow_dispatch:
  push:                      # ‚Üê v3„ÅßËøΩÂä†
    branches:
      - main
      - staging

# ‚úÖ Git pushÊ®©ÈôêÔºàÈ†ÖÁï™4„ÅßË®≠ÂÆöÊ∏à„ÅøÔºâ
permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    # [skip ci] „ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åü„Çâ„Çπ„Ç≠„ÉÉ„ÉóÔºàÁÑ°Èôê„É´„Éº„ÉóÈò≤Ê≠¢Ôºâ
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    env:
      TZ: 'Asia/Tokyo'
    
    steps:
      # ===== Êó¢Â≠ò„ÅÆ„Éì„É´„Éâ„Éª„Éá„Éó„É≠„Ç§„Çπ„ÉÜ„ÉÉ„Éó =====
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch content from microCMS
        env:
          MICROCMS_SERVICE_DOMAIN: ${{ secrets.MICROCMS_SERVICE_DOMAIN }}
          MICROCMS_API_KEY: ${{ secrets.MICROCMS_API_KEY }}
        run: |
          node scripts/fetch-microcms.js

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add src/content/blog/
          git diff --staged --quiet || git commit -m "chore: update content from microCMS [skip ci]"
          git push

      # ===== v3: Cloudflare Pages „Å∏„ÅÆ„Éá„Éó„É≠„Ç§„ÅØ Git ÈÄ£Êê∫„ÅßËá™ÂãïÂÆüË°å =====
      # Build „ÅØ‰∏çË¶ÅÔºàCloudflare Pages ÂÅ¥„ÅßËá™Âãï„Éì„É´„ÉâÔºâ
      # „Åü„Å†„Åó„ÄÅ„É≠„Éº„Ç´„É´„Åß„Éì„É´„Éâ„ÇíÁ¢∫Ë™ç„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ‰ª•‰∏ã„ÇíÊúâÂäπÂåñ:
      # - name: Build Astro site (Optional)
      #   run: npm run build
      #   env:
      #     MODE: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

      # ===== SNSÊäïÁ®ø =====
      - name: Post to Social Media
        id: sns_post
        if: github.event_name == 'repository_dispatch'
        env:
          TUMBLR_CONSUMER_KEY: ${{ secrets.TUMBLR_CONSUMER_KEY }}
          TUMBLR_CONSUMER_SECRET: ${{ secrets.TUMBLR_CONSUMER_SECRET }}
          TUMBLR_OAUTH_TOKEN: ${{ secrets.TUMBLR_OAUTH_TOKEN }}
          TUMBLR_OAUTH_SECRET: ${{ secrets.TUMBLR_OAUTH_SECRET }}
          BLUESKY_IDENTIFIER: ${{ secrets.BLUESKY_IDENTIFIER }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
        run: |
          node scripts/post-to-social.js > sns_result.txt 2>&1
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat sns_result.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ===== ‚úÖ Slack ÈÄöÁü•„Çπ„ÉÜ„ÉÉ„Éó(ÊàêÂäüÊôÇ) =====
      - name: Notify Slack on Success
        if: success()
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          ACTOR="${GITHUB_ACTOR}"
          
          if [ "$BRANCH_NAME" = "main" ]; then
            WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL_PROD }}"
            ENV_NAME="Production"
            SITE_URL="https://example.com"
          else
            WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL_STAGING }}"
            ENV_NAME="Staging"
            SITE_URL="https://staging.example.com"
          fi

          # v3: „Éà„É™„Ç¨„Éº„Çø„Ç§„Éó„ÇíÂà§ÂÆö
          TRIGGER_TYPE=""
          case "${{ github.event_name }}" in
            "push")
              TRIGGER_TYPE="üîß Code Push"
              ;;
            "repository_dispatch")
              TRIGGER_TYPE="üìù microCMS Webhook"
              ;;
            "schedule")
              TRIGGER_TYPE="‚è∞ Scheduled Sync"
              ;;
            "workflow_dispatch")
              TRIGGER_TYPE="üë§ Manual Execution"
              ;;
          esac

          # SNSÊäïÁ®øÁµêÊûú„ÇíÂèñÂæó
          SNS_STATUS=""
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SNS_STATUS="
*SNSÊäïÁ®ø:* Tumblr ‚úÖ / Bluesky ‚úÖ"
          fi

          curl -X POST "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "‚úÖ '"$ENV_NAME"' „Éá„Éó„É≠„Ç§ÊàêÂäü",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ '"$ENV_NAME"' „Éá„Éó„É≠„Ç§ÊàêÂäü"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*„Éñ„É©„É≥„ÉÅ:*
'"$BRANCH_NAME"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*„Éà„É™„Ç¨„Éº:*
'"$TRIGGER_TYPE"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*„Ç≥„Éü„ÉÉ„Éà:*
`'"$COMMIT_SHA"'`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ÂÆüË°åËÄÖ:*
@'"$ACTOR"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*„Çµ„Ç§„Éà URL:*
<'"$SITE_URL"'|'"$SITE_URL"'>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*„Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏:*
'"$COMMIT_MSG"''"$SNS_STATUS"'"
                  }
                }
              ]
            }'

      # ===== ‚ùå Slack ÈÄöÁü•„Çπ„ÉÜ„ÉÉ„Éó(Â§±ÊïóÊôÇ) =====
      - name: Notify Slack on Failure
        if: failure()
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          COMMIT_SHA=$(git rev-parse --short HEAD)
          ACTOR="${GITHUB_ACTOR}"
          
          if [ "$BRANCH_NAME" = "main" ]; then
            WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL_PROD }}"
            ENV_NAME="Production"
          else
            WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL_STAGING }}"
            ENV_NAME="Staging"
          fi

          # v3: „Éà„É™„Ç¨„Éº„Çø„Ç§„Éó„ÇíÂà§ÂÆö
          TRIGGER_TYPE=""
          case "${{ github.event_name }}" in
            "push")
              TRIGGER_TYPE="üîß Code Push"
              ;;
            "repository_dispatch")
              TRIGGER_TYPE="üìù microCMS Webhook"
              ;;
            "schedule")
              TRIGGER_TYPE="‚è∞ Scheduled Sync"
              ;;
            "workflow_dispatch")
              TRIGGER_TYPE="üë§ Manual Execution"
              ;;
          esac

          curl -X POST "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "‚ùå '"$ENV_NAME"' „Éá„Éó„É≠„Ç§Â§±Êïó",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå '"$ENV_NAME"' „Éá„Éó„É≠„Ç§Â§±Êïó"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*„Éñ„É©„É≥„ÉÅ:*
'"$BRANCH_NAME"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*„Éà„É™„Ç¨„Éº:*
'"$TRIGGER_TYPE"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*„Ç≥„Éü„ÉÉ„Éà:*
`'"$COMMIT_SHA"'`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ÂÆüË°åËÄÖ:*
@'"$ACTOR"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*„É≠„Ç∞:*
<'"$GITHUB_SERVER_URL"'/'"$GITHUB_REPOSITORY"'/actions/runs/'"$GITHUB_RUN_ID"'|GitHub Actions „É≠„Ç∞„ÇíÁ¢∫Ë™ç>"
                    }
                  ]
                }
              ]
            }'

